<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <!-- ビューポート：SPでの初期スケールを適切に -->
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブースト！公式サイト（ドラフト）</title>
  <meta name="description" content="同人イベント「ブースト！」の公式サイト（ドラフト版）。開催概要・一般/サークル向けガイド・サークル一覧・アクセス・Q&A・お問い合わせ。">

  <!-- =========================================================
       ベースCSS（バニラCSSのみ／外部依存なし）
       - 色は5色以内（本文/強調/境界/警告/背景）
       ========================================================= -->
  <style>
    :root{
      /* -------------------------------------------
         カラーパレット（5色以内）
         brand: ブランド強調色（可変項目）
         ------------------------------------------- */
      --bg: #ffffff;
      --text: #111111;
      --muted: #6b7280;     /* 説明/補助の文字色 */
      --brand: #0ea5e9;     /* ブランドカラー（例：#0ea5e9） */
      --line: #e5e7eb;      /* 罫線/境界 */
      --warn: #ef4444;      /* 警告 */

      /* コンポーネント寸法 */
      --maxw: 1080px;
      --nav-h: 56px;
      --radius: 14px;
      --shadow: 0 6px 24px rgba(0,0,0,.06);
    }

    /* リセット（最小限） */
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); }
    body { font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Meiryo",sans-serif; line-height:1.7; }
    img { max-width:100%; display:block; }
    a { color: var(--brand); text-decoration: none; }
    a:hover { text-decoration: underline; }
    h1,h2,h3 { line-height:1.3; }
    h1 { font-size: clamp(1.6rem, 2vw + 1rem, 2.2rem); }
    h2 { font-size: clamp(1.2rem, 1.3vw + .9rem, 1.6rem); }
    p,li,dd,dt { font-size: clamp(.98rem, .2vw + .9rem, 1.05rem); }
    small { color: var(--muted); }

    /* コンテナ */
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 0 16px; }

    /* -------------------------------------------------
       固定ナビ：常時表示＋横スクロール
       - スペック6) に基づく
       ------------------------------------------------- */
    .topnav {
      position: sticky;
      top: 0; /* テーマの固定ヘッダーがある場合はここを調整（可変項目） */
      z-index: 50;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--line);
      height: var(--nav-h);
      display: flex; align-items:center;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
    }
    .topnav a {
      display:inline-block; padding: 8px 14px; margin: 0 4px;
      color: var(--text); border:1px solid transparent; border-radius: 999px;
      white-space: nowrap;
    }
    .topnav a:hover { background: #f8fafc; }
    .topnav a.is-active { border-color: var(--brand); color: var(--brand); }

    /* -------------------------------------------------
       HERO：左フライヤー / 右開催概要
       - ユーザー要望「yaroufes風レイアウト」
       ------------------------------------------------- */
    .hero {
      display:grid; gap: 20px;
      grid-template-columns: 1.1fr 1fr;
      align-items: center;
      padding: 20px 0 28px;
    }
    .flyer {
      border-radius: var(--radius);
      overflow: hidden; box-shadow: var(--shadow);
      border: 1px solid var(--line);
      aspect-ratio: 4/3; /* フライヤー比率の仮置き */
      background:#f3f4f6;
    }
    .outline {
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
      background: #fff;
    }
    .kv {
      display: grid; gap: 8px;
    }
    .kv .row { display:flex; gap:8px; align-items: baseline; }
    .kv .key { color: var(--muted); width: 64px; flex: 0 0 auto; font-size: .95rem; }
    .kv .val { font-weight: 700; }

    .cta {
      display:flex; gap: 12px; flex-wrap:wrap; margin-top: 8px;
    }
    .btn {
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 14px; border-radius: 999px;
      border:1px solid var(--brand); color: var(--brand); background: #fff;
      font-weight:700;
    }
    .btn.primary { background: var(--brand); color:#fff; }
    .btn:hover { opacity:.9; text-decoration: none; }

    @media (max-width: 920px){
      .hero{ grid-template-columns: 1fr; }
    }

    /* 見出しが固定ナビに隠れないように（spec 6） */
    section { scroll-margin-top: calc(var(--nav-h) + 16px); }

    /* -------------------------------------------------
       アコーディオン（Comiket風に「閉じられる」UI）
       - details/summaryを使うことでアクセシブルに
       ------------------------------------------------- */
    details.accordion{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      margin: 16px 0;
      background: #fff;
      box-shadow: var(--shadow);
    }
    details.accordion > summary{
      list-style: none;
      cursor: pointer;
      padding: 14px 16px;
      font-weight:700;
      display:flex; align-items:center; justify-content:space-between;
    }
    details.accordion > summary::-webkit-details-marker{ display:none; }
    .acc-body{ padding: 0 16px 16px; border-top:1px solid var(--line); }

    /* テーブル（当日スケジュール） */
    .tbl{ width:100%; border-collapse: collapse; }
    .tbl th, .tbl td{ border-bottom:1px solid var(--line); padding:10px; text-align:left; }
    .tbl th{ color: var(--muted); font-weight:700; width: 120px; }

    /* -------------------------------------------------
       サークル一覧（検索/50音/ページング/SNSリンク）
       ------------------------------------------------- */
    .circle-tools{
      display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin: 8px 0 12px;
    }
    .circle-tools input[type="search"]{
      flex: 1 1 240px; min-width: 200px;
      border:1px solid var(--line); border-radius: 10px; padding: 10px 12px;
      outline: none;
    }
    .kana-tabs{
      display:flex; gap:6px; overflow-x:auto; padding-bottom: 6px;
    }
    .kana-tabs button{
      border:1px solid var(--line); background:#fff; color:var(--text);
      padding: 8px 10px; border-radius: 999px; white-space: nowrap; cursor: pointer;
    }
    .kana-tabs button.is-active{
      border-color: var(--brand); color: var(--brand); font-weight:700;
    }

    .circle-grid{
      display:grid; gap: 12px;
      grid-template-columns: repeat(4, 1fr);
    }
    @media (max-width: 1024px){ .circle-grid{ grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 720px){ .circle-grid{ grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 460px){ .circle-grid{ grid-template-columns: 1fr;} }

    .card{
      border:1px solid var(--line); border-radius: 14px; padding: 12px;
      background:#fff; box-shadow: var(--shadow);
      display:grid; grid-template-columns: 64px 1fr; gap: 12px; align-items: center;
    }
    .thumb{
      width: 64px; height: 64px; border-radius: 8px; overflow: hidden; background:#f3f4f6;
      display:flex; align-items:center; justify-content:center; border:1px solid var(--line);
    }
    .thumb img{ width:100%; height:100%; object-fit: cover; }
    .meta .name{ font-weight: 800; }
    .meta .sub{ color: var(--muted); font-size: .9rem; }
    .meta .space{ font-size:.92rem; margin-top: 2px; }
    .sns{
      display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px;
    }
    .sns a{
      border:1px solid var(--line); border-radius: 999px; padding: 6px 10px; display:inline-flex; align-items:center; gap:6px;
      color: var(--text); background:#fff;
    }
    .sns svg{ width:16px; height:16px; }
    .grid-footer{ display:flex; justify-content:center; margin: 12px 0 2px; }
    .loadmore{
      padding: 10px 16px; border-radius: 999px; border:1px solid var(--brand);
      background:#fff; color:var(--brand); cursor: pointer; font-weight:700;
    }
    .count { color: var(--muted); }

    /* アクセス／注意ボックス */
    .note{
      border: 1px dashed var(--line);
      background:#fafafa;
      border-radius: var(--radius);
      padding: 12px;
    }

    /* 警告メッセージ */
    .alert{ color: var(--warn); font-weight:700; }
  </style>
</head>
<body>

  <!-- =========================================================
       固定ナビ（横スクロール可）
       - 各セクションへアンカーリンク
       - scrollspy風のis-activeは最小実装（JSで切替）
       ========================================================= -->
  <nav class="topnav" id="topnav">
    <div class="wrap" style="display:flex; gap:4px;">
      <a href="#hero" class="is-active">開催概要</a>
      <a href="#news">最新情報</a>
      <a href="#schedule">当日スケジュール</a>
      <a href="#general">一般参加</a>
      <a href="#circle">サークル参加</a>
      <a href="#circles">サークル一覧</a>
      <a href="#access">アクセス</a>
      <a href="#qa">Q&amp;A</a>
      <a href="#contact">お問い合わせ</a>
    </div>
  </nav>

  <main class="wrap">

    <!-- =======================================================
         HERO：左フライヤー / 右開催概要
         - 左にフライヤー画像（assets/img/flyer.jpg を差し替え）
         - 右に開催情報とCTA
         ======================================================= -->
    <section id="hero" class="hero">
      <div class="flyer">
        <!-- ここにイベントフライヤー。差し替え推奨。altは必ず意味のある説明を -->
        <img src="./assets/img/flyer.jpg" alt="イベント公式フライヤー" loading="eager" />
      </div>

      <div class="outline">
        <h1>ブースト！</h1>
        <div class="kv" aria-label="開催概要">
          <div class="row"><div class="key">開催日</div><div class="val">2025/10/12（日）</div></div>
          <div class="row"><div class="key">時間</div><div class="val">10:00〜16:00</div></div>
          <div class="row"><div class="key">会場</div><div class="val">〇〇コンベンションホール A館</div></div>
          <div class="row"><div class="key">入場</div><div class="val">一般：1,000円（再入場可）</div></div>
        </div>
        <div class="cta" role="group" aria-label="主要導線">
          <a class="btn primary" href="#general">一般参加ガイド</a>
          <a class="btn" href="#circle">サークル参加ガイド</a>
          <a class="btn" href="#circles">サークル一覧</a>
        </div>
        <small>※ 表示の料金・内容はドラフトです。確定次第更新します。</small>
      </div>
    </section>

    <!-- =======================================================
         最新情報（アコーディオン）
         - 2〜5件。日付＋40字以内見出し
         ======================================================= -->
    <details class="accordion" id="news" open>
      <summary>最新情報</summary>
      <div class="acc-body">
        <ul>
          <li>2025/08/10　会場内案内（文章）を公開しました。</li>
          <li>2025/08/05　サークル一覧の検索と50音タブを追加しました。</li>
          <li>2025/08/01　お問い合わせ（GitHub Issueフォーム）を試験公開。</li>
        </ul>
        <div class="note"><small>古いお知らせはアーカイブへ移動します（最大5件表示）。</small></div>
      </div>
    </details>

    <!-- =======================================================
         当日スケジュール（アコーディオン）
         - 表：時刻/内容（6〜8行）
         ======================================================= -->
    <details class="accordion" id="schedule" open>
      <summary>当日スケジュール</summary>
      <div class="acc-body">
        <table class="tbl">
          <tbody>
            <tr><th>09:00</th><td>サークル入場開始・搬入</td></tr>
            <tr><th>09:30</th><td>年齢確認ブースオープン</td></tr>
            <tr><th>10:00</th><td>一般入場開始</td></tr>
            <tr><th>12:00</th><td>抽選会（ブークジ）</td></tr>
            <tr><th>15:30</th><td>頒布終了アナウンス</td></tr>
            <tr><th>16:00</th><td>イベント終了・撤収開始</td></tr>
          </tbody>
        </table>
      </div>
    </details>

    <!-- =======================================================
         一般参加（アコーディオン）
         ======================================================= -->
    <details class="accordion" id="general">
      <summary>一般参加ガイド</summary>
      <div class="acc-body">
        <h3>入場・再入場</h3>
        <ul>
          <li>入場：リストバンドを提示してください。</li>
          <li>再入場：当日限り可（リストバンド確認）。</li>
        </ul>
        <h3>年齢確認</h3>
        <p>R-18 頒布物の閲覧・購入には顔写真付き身分証が必要です。</p>
        <h3>抽選</h3>
        <p>抽選券は先着配布。12:00 に会場中央で実施します。</p>
        <h3>持ち物・注意</h3>
        <ul>
          <li>現金の小分け・エコバッグ・水分補給を推奨。</li>
          <li>撮影はサークルの許可がある場合のみ。</li>
        </ul>
      </div>
    </details>

    <!-- =======================================================
         サークル参加（アコーディオン）
         ======================================================= -->
    <details class="accordion" id="circle">
      <summary>サークル参加ガイド</summary>
      <div class="acc-body">
        <h3>参加資格・費用</h3>
        <ul>
          <li>同人誌/イラスト/グッズ等の頒布を行う個人・団体。</li>
          <li>ブース：1ブース 5,000円（机半分/椅子1脚）</li>
        </ul>
        <h3>当日フロー</h3>
        <ol>
          <li>09:00〜 搬入・設営</li>
          <li>09:30〜 見本誌確認</li>
          <li>16:00〜 撤収</li>
        </ol>
        <h3>表記・見本誌</h3>
        <p>年齢区分・警告ラベル・価格表示を明確に記載してください。</p>
      </div>
    </details>

    <!-- =======================================================
         サークル一覧（アコーディオン）
         - 仕様まとめ：
           * CSV（./content/circle-list.csv）をfetchして描画
           * 検索（部分一致）＋ 50音タブ（あ/か/…/わ）＋「企業」タブ
           * 初期は「段階表示」：例 24件ずつ表示、「もっと見る」で追加
           * SNS 複数対応：ヘッダが sns で始まる列（例：sns1,sns2, ...）や
             "sns" 1列にカンマ/空白区切りでURL列挙も可
           * kana 列に "kigyou" を入れると「企業」タブに分類
         ======================================================= -->
    <details class="accordion" id="circles" open>
      <summary>サークル一覧</summary>
      <div class="acc-body">

        <!-- 操作UI -->
        <div class="circle-tools">
          <input id="q" type="search" placeholder="サークル名・PN・スペース番号で検索" aria-label="サークル検索（部分一致）" />
          <span class="count" id="count">0件</span>
        </div>

        <!-- 50音＋企業タブ -->
        <div class="kana-tabs" role="tablist" aria-label="50音インデックス">
          <!-- JSでボタン生成（ALL / あ / か / さ / た / な / は / ま / や / ら / わ / 企業） -->
        </div>

        <!-- グリッド本体 -->
        <div class="circle-grid" id="grid" aria-live="polite" aria-busy="true">
          <!-- JSでカードを段階的に追加 -->
        </div>

        <!-- もっと見る -->
        <div class="grid-footer">
          <button class="loadmore" id="loadmore" style="display:none;">もっと見る</button>
        </div>

        <!-- 読み込みエラー -->
        <p id="error" class="alert" style="display:none;">
          サークル一覧の読み込みに失敗しました。時間をおいて再読み込みしてください。
          <br><small>（ローカルファイル直開きだと CORS 制限で失敗します。GitHub Pages など http/https 上でご確認ください）</small>
        </p>

        <!-- カードテンプレート（template要素） -->
        <template id="card-tpl">
          <article class="card">
            <div class="thumb" data-thumb>
              <!-- サムネがあれば img をJSで挿入。なければSVGのダミーを表示 -->
              <svg viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="3" width="18" height="18" fill="#e5e7eb" stroke="#d1d5db"/></svg>
            </div>
            <div class="meta">
              <div class="name" data-name>サークル名</div>
              <div class="sub" data-pn>PN</div>
              <div class="space" data-space>スペース番号</div>
              <div class="sns" data-sns><!-- SNSバッジを挿入 --></div>
            </div>
          </article>
        </template>
      </div>
    </details>

    <!-- =======================================================
         アクセス（アコーディオン）
         ======================================================= -->
    <details class="accordion" id="access">
      <summary>アクセス</summary>
      <div class="acc-body">
        <p>〇〇駅から徒歩5分、△△駅から徒歩8分。会場駐車場は関係者のみ利用可。</p>
        <div class="note"><small>近隣の迷惑となる駐停車はご遠慮ください。</small></div>
      </div>
    </details>

    <!-- =======================================================
         Q&A（アコーディオン）
         - 3〜5項目の短いQAを推奨
         ======================================================= -->
    <details class="accordion" id="qa">
      <summary>Q&amp;A</summary>
      <div class="acc-body">
        <dl>
          <dt>Q. 再入場はできますか？</dt>
          <dd>リストバンドの提示で当日中は再入場可能です。</dd>

          <dt>Q. クロークはありますか？</dt>
          <dd>会場1Fに簡易クローク（有料）を設置予定です。</dd>

          <dt>Q. お問い合わせの返答はありますか？</dt>
          <dd>個別返信はありません。必要に応じて更新情報へ反映します。</dd>
        </dl>
      </div>
    </details>

    <!-- =======================================================
         お問い合わせ（アコーディオン）
         - GitHub Issueフォームへ遷移（target=_blank）
         ======================================================= -->
    <details class="accordion" id="contact">
      <summary>お問い合わせ</summary>
      <div class="acc-body">
        <p>バグ報告／改善要望のみ受け付けます。個人情報は記載しないでください。</p>
        <p><a class="btn primary" href="https://github.com/your/repo/issues/new?template=feedback.yml" target="_blank" rel="noopener">GitHub Issueフォームを開く</a></p>
        <small>返信は個別に行いません。必要に応じて「最新情報」に反映します。</small>
      </div>
    </details>

    <footer style="margin: 32px 0 48px; text-align:center; color:var(--muted);">
      <small>&copy; 2025 ブースト実行委員会</small>
    </footer>
  </main>

  <!-- =========================================================
       JS：バニラJSのみ
       - 検索/50音タブ/段階表示/CSV読込/SNSリンク生成/scrollspy
       ========================================================= -->
  <script>
  // ================= ユーティリティ =================

  /** 簡易CSVパーサー（引用符・カンマ・改行を考慮）
   *  - 引数：CSV文字列
   *  - 戻り：{ header: string[], rows: string[][] }
   *  - コメント：小さめのCSVを想定（GitHub PagesでのWebカタログ用途）
   */
  function parseCSV(text){
    const rows = [];
    let cur = '', row = [], quoted = false;
    for(let i=0;i<text.length;i++){
      const c = text[i];
      if (quoted){
        if (c === '"'){
          if (text[i+1] === '"'){ cur += '"'; i++; } // エスケープされた引用符
          else { quoted = false; }
        } else {
          cur += c;
        }
      } else {
        if (c === '"'){ quoted = true; }
        else if (c === ','){ row.push(cur); cur=''; }
        else if (c === '\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
        else if (c === '\r'){ /* Windows改行は無視 */ }
        else { cur += c; }
      }
    }
    if (cur.length>0 || row.length>0) { row.push(cur); rows.push(row); }
    const header = rows.shift() || [];
    return { header, rows };
  }

  /** テキスト正規化（検索用：全角→半角・小文字化） */
  function normalize(s){
    return (s || '')
      .toString()
      .trim()
      .toLowerCase()
      .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0))
      .replace(/\s+/g,' ');
  }

  /** ドメインに応じたアイコンSVGを返す（最小セット） */
  function iconFor(url){
    // コメント：アイコンはインラインSVG。外部アセット不要。
    const u = new URL(url);
    const h = u.hostname.toLowerCase();

    const wrap = (d) => `<svg viewBox="0 0 24 24" aria-hidden="true">${d}</svg>`;

    if (h.includes('twitter.com') || h.includes('x.com')){
      return wrap(`<path d="M20 7.2c-.5.2-1 .3-1.6.4.6-.4 1-.9 1.2-1.6-.6.4-1.2.6-1.9.8A3 3 0 0 0 12 9.6c0 .2 0 .4.1.6A8.6 8.6 0 0 1 4.2 6c-.3.5-.4 1-.4 1.6 0 1 .6 2 1.6 2.6-.5 0-1-.2-1.4-.4v.1c0 1.5 1.1 2.8 2.6 3.1-.3.1-.6.1-.9.1-.2 0-.4 0-.6-.1.4 1.2 1.6 2.1 3 2.1A6.1 6.1 0 0 1 4 17.8c-1 0-1.3 0-2-.1a8.6 8.6 0 0 0 13.2-7.3 3.2 3.2 0 0 0 0-.5c.6-.4 1.1-.9 1.5-1.5Z"/>`);
    }
    if (h.includes('bsky.app')){
      return wrap(`<path d="M12 10c3.5-4.8 7.5-6.9 9.3-5 .9.8-.1 3-1.8 5 2.4-.5 4.6-.1 5.2 1.7.9 2.8-3.6 4.3-8.6 2.9.6 3.6-.4 7.1-2.1 7.1s-2.7-3.5-2.1-7.1c-5 1.4-9.5-.1-8.6-2.9.6-1.8 2.8-2.2 5.2-1.7-1.7-2-2.6-4.2-1.8-5 1.8-1.9 5.8.2 9.3 5Z"/>`);
    }
    if (h.includes('instagram.com')){
      return wrap(`<rect x="3" y="3" width="18" height="18" rx="4"/><circle cx="12" cy="12" r="4"/><circle cx="17.5" cy="6.5" r="1.5"/>`);
    }
    if (h.includes('pixiv.net')){
      return wrap(`<path d="M6 5h9a5 5 0 1 1 0 10H9v4H6V5zm9 7a2 2 0 0 0 0-4H9v4h6z"/>`);
    }
    if (h.includes('booth.pm')){
      return wrap(`<path d="M3 7h18v10H3V7zm2 2v6h14V9H5z"/><path d="M4 5h16l1 2H3l1-2z"/>`);
    }
    if (h.includes('youtube.com') || h.includes('youtu.be')){
      return wrap(`<path d="M22 12s0-3.4-.4-4.9c-.2-.8-.8-1.4-1.6-1.6C18.6 5 12 5 12 5s-6.6 0-8 .5c-.8.2-1.4.8-1.6 1.6C2 8.6 2 12 2 12s0 3.4.4 4.9c.2.8.8 1.4 1.6 1.6 1.4.5 8 .5 8 .5s6.6 0 8-.5c.8-.2 1.4-.8 1.6-1.6.4-1.5.4-4.9.4-4.9z"/><path d="M10 15V9l6 3-6 3z" />`);
    }
    if (h.includes('twitch.tv')){
      return wrap(`<path d="M4 3h16v10l-4 4h-4l-2 2H8v-2H4V3zm3 2v9h9l2-2V5H7z"/><path d="M13 7h2v4h-2zM9 7h2v4H9z"/>`);
    }
    if (h.includes('threads.net')){
      return wrap(`<path d="M12 3c5 0 9 4 9 9s-4 9-9 9-9-4-9-9 4-9 9-9zm1 5c3 0 5 1.7 5 4.2 0 2.7-2.3 4.8-5.6 4.8-2.7 0-4.6-1.5-4.7-3.6h2.2c.2 1 1.1 1.8 2.5 1.8 1.8 0 3.1-1 3.1-2.7 0-1.3-1-2.3-2.5-2.5v1.6h-1.9V8c.6-.1 1.3-.2 1.9-.2Z"/>`);
    }
    // 汎用（Webサイト）
    return wrap(`<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm0 2a8 8 0 0 1 7.7 6H12V4Zm0 16a8 8 0 0 1-7.7-6H12v6Z"/>`);
  }

  // ================= サークル一覧 =================

  // 50音タブのリスト（「企業」を末尾に追加）
  const KANA_TABS = ['ALL','あ','か','さ','た','な','は','ま','や','ら','わ','企業'];
  const PAGE_SIZE = 24;     // 段階表示の1ページ件数（調整可）
  const CSV_PATH = './content/circle-list.csv'; // CSVの相対パス

  // 状態管理
  const state = {
    all: [],         // 全レコード（配列の各要素はオブジェクトに整形）
    filtered: [],    // 検索＋タブ適用後の配列
    page: 1,         // 現在のページ（1始まり）
    tab: 'ALL',      // 現在の50音タブ
    q: ''            // 現在の検索クエリ
  };

  /** CSVを取得してstate.allへ格納 */
  async function loadCircles(){
    const grid = document.getElementById('grid');
    const err = document.getElementById('error');
    grid.setAttribute('aria-busy','true');
    try{
      const res = await fetch(CSV_PATH, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      const { header, rows } = parseCSV(text);

      // ヘッダ→インデックス
      const idx = {};
      header.forEach((h,i)=> idx[h.trim().toLowerCase()] = i);

      // 想定カラム（柔軟に吸収）
      // - 必須相当：name, pn, space, kana
      // - 任意：thumb（画像パス相対 or URL）, sns, sns1, sns2...
      state.all = rows.map(r => {
        const pick = k => r[idx[k]] ?? '';
        const obj = {
          name: pick('name') || pick('circle') || '',
          pn: pick('pn') || pick('penname') || '',
          space: pick('space') || pick('space_no') || '',
          kana: (pick('kana') || '').toLowerCase(),  // 'kigyou' で企業タブ
          thumb: pick('thumb') || '',
          // SNS：ヘッダが "sns" で始まる列をすべて集約（空は除外）
          sns: []
        };

        // "sns" 1列に複数URLのケース（カンマ/空白/パイプ区切りを許容）
        const s0 = pick('sns');
        if (s0){
          s0.split(/[\s,|]+/).forEach(u => u && obj.sns.push(u));
        }
        // sns1, sns2, snsX ...
        Object.keys(idx).forEach(key=>{
          if (key.startsWith('sns') && key !== 'sns'){
            const v = pick(key);
            if (v) obj.sns.push(v);
          }
        });

        // 互換：website/url列もあればSNSに含める
        const w = pick('website') || pick('url');
        if (w) obj.sns.push(w);

        return obj;
      });

      // 初期描画
      applyFilters();
    }catch(e){
      console.error(e);
      err.style.display = 'block';
    }finally{
      grid.removeAttribute('aria-busy');
    }
  }

  /** フィルタ（検索＋50音タブ）を適用し、ページをリセット */
  function applyFilters(){
    const qn = normalize(state.q);
    state.filtered = state.all.filter(item => {
      // タブ判定
      let tabOK = true;
      if (state.tab && state.tab !== 'ALL'){
        if (state.tab === '企業'){
          tabOK = (item.kana === 'kigyou');
        } else {
          // 先頭の行単位（あ/か/…/わ）に属するかどうか
          // kana 列が未設定の場合は検索のみでヒットさせる
          const k = (item.kana || '').charAt(0);
          tabOK = k === state.tab;
        }
      }

      // 検索（name / pn / space 部分一致）
      const qs = qn.length ? qn : '';
      if (!qs) return tabOK;

      const hay = normalize(item.name + ' ' + item.pn + ' ' + item.space);
      return tabOK && hay.includes(qs);
    });

    state.page = 1;
    renderGrid();
  }

  /** グリッドへカードを段階描画 */
  function renderGrid(){
    const grid = document.getElementById('grid');
    const count = document.getElementById('count');
    const more = document.getElementById('loadmore');

    grid.innerHTML = ''; // 一旦クリア

    // 現在ページまでの件数
    const limit = state.page * PAGE_SIZE;
    const show = state.filtered.slice(0, limit);

    // 件数表示
    count.textContent = `${state.filtered.length}件${(state.tab && state.tab!=='ALL') ? '（'+state.tab+'）' : ''}`;

    // カードを挿入
    const tpl = document.getElementById('card-tpl');
    show.forEach(it => {
      const node = tpl.content.cloneNode(true);

      // サムネ
      const th = node.querySelector('[data-thumb]');
      if (it.thumb){
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.decoding = 'async';
        // 相対/絶対のどちらでも可（assets/circle/*.jpg など）
        img.src = it.thumb;
        img.alt = (it.name || 'サークル') + 'のサムネイル';
        th.innerHTML = '';
        th.appendChild(img);
      }

      // テキスト群
      node.querySelector('[data-name]').textContent = it.name || '（名称未設定）';
      node.querySelector('[data-pn]').textContent = it.pn ? `PN：${it.pn}` : '';
      node.querySelector('[data-space]').textContent = it.space ? `スペース：${it.space}` : '';

      // SNSリンク
      const snsBox = node.querySelector('[data-sns]');
      (it.sns || []).forEach(u=>{
        try{
          const a = document.createElement('a');
          a.href = u; a.target = '_blank'; a.rel = 'noopener';
          a.innerHTML = `${iconFor(u)}<span>${new URL(u).hostname.replace(/^www\./,'')}</span>`;
          snsBox.appendChild(a);
        }catch(e){
          // URLとして不正ならスキップ
        }
      });

      grid.appendChild(node);
    });

    // もっと見る表示切替
    more.style.display = (state.filtered.length > show.length) ? 'inline-flex' : 'none';
  }

  /** 「もっと見る」クリック */
  function onLoadMore(){
    state.page++;
    renderGrid();
  }

  /** 50音タブ生成 */
  function buildKanaTabs(){
    const root = document.querySelector('.kana-tabs');
    root.innerHTML = '';
    KANA_TABS.forEach(k=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.textContent = k;
      if (k === state.tab) b.classList.add('is-active');
      b.addEventListener('click', ()=>{
        state.tab = k;
        // 選択スタイル切替
        root.querySelectorAll('button').forEach(x=>x.classList.remove('is-active'));
        b.classList.add('is-active');
        applyFilters();
      });
      root.appendChild(b);
    });
  }

  // ================= ナビのscrollspy風 =================
  function initScrollSpy(){
    const links = Array.from(document.querySelectorAll('.topnav a'));
    const targets = links.map(a => document.querySelector(a.getAttribute('href'))).filter(Boolean);

    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if (e.isIntersecting){
          const id = '#'+e.target.id;
          links.forEach(l => l.classList.toggle('is-active', l.getAttribute('href')===id));
        }
      });
    }, { rootMargin: '-60% 0px -35% 0px', threshold: 0 });

    targets.forEach(t => io.observe(t));
  }

 
