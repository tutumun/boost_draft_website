<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ブースト！｜公式ドラフト</title>
  <meta name="description" content="同人イベント「ブースト！」のドラフトサイト。開催日・会場・参加方法を30秒で把握できます。">
  <!-- 必要なら assets/boost-ux.css を作って分離。ここでは最低限は埋め込み -->
  <style>
    /* =============================
       基本トークン
       ============================= */
    :root{
      --c-text:#1f2328; --c-accent:#0ea5e9; --c-line:#e5e7eb;
      --c-bg:#ffffff; --nav-h:56px; --wrap:1100px;
    }
    html,body{margin:0;padding:0;background:var(--c-bg);color:var(--c-text);
      font-family:system-ui,"Noto Sans JP",sans-serif;line-height:1.6}
    img{max-width:100%;height:auto;vertical-align:middle}
    a{color:var(--c-accent);text-decoration:none}
    h1,h2{line-height:1.25;margin:0 0 .5em}
    h2{font-size:1.35rem}
    .sr{position:absolute!important;clip:rect(1px,1px,1px,1px);clip-path:inset(50%);width:1px;height:1px;overflow:hidden;white-space:nowrap}

    /* =============================
       固定ナビ
       - 横スクロール可
       ============================= */
    .nav{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--c-line);
      height:var(--nav-h);display:flex;align-items:center;overflow:auto}
    .nav__links{display:flex;gap:8px;padding:0 12px}
    .chip{padding:8px 12px;border:1px solid var(--c-line);border-radius:999px;white-space:nowrap;color:#0f172a;background:#fff}
    .chip.is-active{border-color:var(--c-accent);background:#e0f2fe}

    /* =============================
       汎用カード
       ============================= */
    .card{background:#fff;border:1px solid var(--c-line);border-radius:12px}
    .card--body{padding:20px}

    /* =============================
       ヒーロー（左：画像 / 右：開催概要）
       ============================= */
    .hero{max-width:var(--wrap);margin:16px auto;padding:0 16px}
    .hero__grid{display:grid;gap:16px;grid-template-columns:1.1fr 1fr}
    @media(max-width:900px){.hero__grid{grid-template-columns:1fr}}
    .tag{padding:2px 8px;background:#f1f5f9;border:1px solid var(--c-line);border-radius:6px}
    .cta{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
    .btn{padding:10px 16px;border-radius:8px;background:var(--c-accent);color:#fff;font-weight:600}
    .btn--ghost{background:#fff;color:#0369a1;border:1px solid var(--c-accent)}

    /* =============================
       セクション（アンカー余白）
       ============================= */
    section{max-width:var(--wrap);margin:24px auto;padding:0 16px;scroll-margin-top:calc(var(--nav-h)+10px)}

    /* =============================
       アコーディオン（トップのメニュー群を意識）
       ============================= */
    .accordion{display:grid;gap:10px}
    details{border:1px solid var(--c-line);border-radius:10px;background:#fff}
    summary{cursor:pointer;padding:14px 16px;font-weight:600;list-style:none}
    summary::-webkit-details-marker{display:none}
    details > div{padding:0 16px 14px}

    /* =============================
       スケジュール表（簡易）
       ============================= */
    .tbl{width:100%;border-collapse:separate;border-spacing:0 6px}
    .tbl th,.tbl td{padding:10px 12px;border:1px solid var(--c-line);background:#fff}
    .tbl th{width:120px;background:#f8fafc;text-align:left}

    /* =============================
       サークル一覧 検索UI＋50音（企業対応込み）
       ============================= */
    .kana{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 14px}
    .kana__btn{padding:8px 10px;border:1px solid var(--c-line);border-radius:999px;background:#fff;cursor:pointer}
    .kana__btn[aria-pressed="true"]{border-color:var(--c-accent);background:#e0f2fe;color:#0369a1}
    .search{display:flex;flex-direction:column;gap:8px;margin:0 0 8px}
    #circle-q{padding:12px 14px;border:1px solid var(--c-line);border-radius:10px;font-size:1rem;width:100%;max-width:680px}
    .resultline{margin:6px 0 12px;color:#475569}

    .cards{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media(max-width:1000px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:640px){.cards{grid-template-columns:1fr}}
    .card--circle{padding:14px}
    .circle__head{display:flex;flex-direction:column;gap:4px;margin-bottom:6px}
    .circle__title{font-weight:700}
    .circle__space{font-size:.9rem;color:#334155;margin-left:6px}
    .circle__meta{font-size:.9rem;color:#64748b}
    .circle__body{font-size:.95rem}

    /* サムネ（任意） */
    .circle__row{display:grid;grid-template-columns:84px 1fr;gap:10px;align-items:start}
    .circle__thumb{width:84px;height:84px;border-radius:10px;object-fit:cover;border:1px solid var(--c-line);background:#f8fafc}
    @media (max-width:480px){
      .circle__row{grid-template-columns:64px 1fr}
      .circle__thumb{width:64px;height:64px}
    }

    /* フッタ的余白 */
    .footspace{height:40px}

    /* ========== 追加: 段階表示＆SNS＆上部へ戻る ========== */
	/* さらに表示ボタン */
	.loadmore-wrap{display:flex;justify-content:center;margin:12px 0 0}
	.loadmore{padding:10px 16px;border:1px solid var(--c-line);border-radius:8px;background:#fff;cursor:pointer}
	.loadmore[disabled]{opacity:.5;cursor:default}

	/* 無限読み足しトリガー（画面外の見えない線） */
	.observer{width:100%;height:1px}

	/* SNSリンクの水平リスト */
	.sns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
	.sns a{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border:1px solid var(--c-line);
	  border-radius:999px;background:#fff;font-size:.9rem}
	.sns .i{width:16px;height:16px;display:inline-block}
    /* SNSボタン内のfaviconを16pxで表示（角丸で見栄えUP） */
    .sns .fav{
      width:16px; height:16px; border-radius:4px; object-fit:cover;
    }
	/* 先頭へ戻る */
	.to-top{position:fixed;right:16px;bottom:16px;z-index:30;padding:10px 12px;border-radius:999px;
	  background:#0f172a;color:#fff;opacity:.85;display:none}
	.to-top.is-show{display:block}

  </style>
</head>
<body>
  <!-- =========================================
       固定ナビ（横スクロール可能）
       ========================================= -->
  <nav class="nav" aria-label="主要ナビゲーション">
    <div class="nav__links" id="js-nav">
      <a class="chip" href="#news">最新情報</a>
      <a class="chip" href="#schedule">当日スケジュール</a>
      <a class="chip" href="#general">一般参加</a>
      <a class="chip" href="#circle">サークル参加</a>
      <a class="chip" href="#list">サークル一覧</a>
      <a class="chip" href="#access">アクセス</a>
      <a class="chip" href="#qa">Q&amp;A</a>
      <a class="chip" href="#contact">お問い合わせ</a>
    </div>
  </nav>

  <!-- =========================================
       ヒーロー（左：フライヤー画像 / 右：開催概要）
       - 画像は自由に差し替えOK：docs/assets/flyer-placeholder.jpg
       ========================================= -->
  <header class="hero" id="top">
    <div class="hero__grid">
      <div class="card card--image">
        <img src="./assets/flyer-placeholder.jpg" alt="イベントフライヤー（イメージ）" />
      </div>
      <div class="card">
        <div class="card--body">
          <h1>ブースト！</h1>
          <div><span class="tag" aria-hidden="true">開催日</span> 2025/11/23（日） 10:00–16:00</div>
          <div><span class="tag" aria-hidden="true">会　場</span> ○○コンベンションセンター</div>
          <div><span class="tag" aria-hidden="true">入　場</span> 一般 1,000円／再入場可</div>
          <div class="cta">
            <a class="btn" href="#general">一般参加ガイド</a>
            <a class="btn btn--ghost" href="#circle">サークル参加ガイド</a>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- =========================================
       最新情報（アコーディオン）
       ========================================= -->
  <section id="news" aria-labelledby="news-h">
    <h2 id="news-h">最新情報</h2>
    <div class="accordion">
      <details open>
        <summary>2025/08/11 ドラフト公開</summary>
        <div>GitHub Pagesにてドラフト版を公開しました。</div>
      </details>
      <!-- 以降、最大5件まで（運用で差し替え可 / 将来JSON自動化も可能） -->
    </div>
  </section>

  <!-- =========================================
       当日スケジュール（簡易表）
       ========================================= -->
  <section id="schedule" aria-labelledby="schedule-h">
    <h2 id="schedule-h">当日スケジュール</h2>
    <table class="tbl" aria-describedby="schedule-note">
      <tbody>
        <tr><th scope="row">09:00</th><td>サークル入場開始</td></tr>
        <tr><th scope="row">10:00</th><td>一般入場開始</td></tr>
        <tr><th scope="row">12:00</th><td>抽選企画（予定）</td></tr>
        <tr><th scope="row">16:00</th><td>閉場</td></tr>
      </tbody>
    </table>
    <p id="schedule-note" class="sr">時刻は目安です。変更の可能性があります。</p>
  </section>

  <!-- =========================================
       一般参加ガイド（アコーディオン）
       ========================================= -->
  <section id="general" aria-labelledby="general-h">
    <h2 id="general-h">一般参加ガイド</h2>
    <div class="accordion">
      <details open><summary>入場方法</summary><div>入場料金：1,000円。再入場可（リストバンド提示）。</div></details>
      <details><summary>年齢確認</summary><div>R-18エリアは年齢確認必須。公的身分証をご提示ください。</div></details>
      <details><summary>持ち物・注意</summary><div>小銭・エコバッグ・水分補給。会場指示に従ってください。</div></details>
    </div>
  </section>

  <!-- =========================================
       サークル参加ガイド（アコーディオン）
       ========================================= -->
  <section id="circle" aria-labelledby="circle-h">
    <h2 id="circle-h">サークル参加ガイド</h2>
    <div class="accordion">
      <details open><summary>参加資格</summary><div>オリジナル同人の頒布を行う個人・団体。</div></details>
      <details><summary>ブース・料金</summary><div>1ブース 5,000円（机半分／椅子1脚）</div></details>
      <details><summary>当日フロー</summary><div>搬入→設営→開場→撤収。見本誌確認あり。</div></details>
    </div>
  </section>

  <!-- =========================================
       サークル一覧（CSVロード＋検索＋50音＋企業）
       ========================================= -->
  <section id="list" aria-labelledby="list-h">
    <h2 id="list-h">サークル一覧</h2>
    <p class="desc">検索（サークル名 / PN / スペース番号 / 区分）＋50音/企業で絞り込みできます。</p>

    <!-- 50音インデックス（企業を末尾に追加） -->
    <nav class="kana" aria-label="50音インデックス">
      <!-- data-kana はフィルタキー。'all' は全件表示 -->
      <button class="kana__btn" type="button" data-kana="all" aria-pressed="true">全件</button>
      <button class="kana__btn" type="button" data-kana="a">あ行</button>
      <button class="kana__btn" type="button" data-kana="k">か行</button>
      <button class="kana__btn" type="button" data-kana="s">さ行</button>
      <button class="kana__btn" type="button" data-kana="t">た行</button>
      <button class="kana__btn" type="button" data-kana="n">な行</button>
      <button class="kana__btn" type="button" data-kana="h">は行</button>
      <button class="kana__btn" type="button" data-kana="m">ま行</button>
      <button class="kana__btn" type="button" data-kana="y">や行</button>
      <button class="kana__btn" type="button" data-kana="r">ら行</button>
      <button class="kana__btn" type="button" data-kana="w">わ行</button>
      <!-- ▼追加：企業フィルタ（CSVの kana=kigyou に対応） -->
      <button class="kana__btn" type="button" data-kana="kigyou">企業</button>
    </nav>

    <!-- キーワード検索 -->
    <div class="search">
      <label for="circle-q" class="sr">サークル検索</label>
      <input id="circle-q" type="search" inputmode="search" placeholder="例）ブースト / 彩 / A-01 / 漫画 など" aria-describedby="search-help" />
      <div id="search-help" class="sr">スペース番号や区分でも検索可能です。</div>
    </div>

    <!-- ヒット件数（ライブリージョンで読み上げ） -->
    <div class="resultline" aria-live="polite" aria-atomic="true">該当：<span id="hit">0</span>件</div>

    <!-- カード一覧（CSVから生成） -->
    <div class="cards" id="circle-cards"></div>
    <!-- さらに表示ボタン（手動読み足し用） -->
	<div class="loadmore-wrap">
	  <button id="loadmore" class="loadmore" type="button">さらに表示</button>
	</div>
	<!-- 無限読み足しの観測点（画面下） -->
	<div id="observer" class="observer" aria-hidden="true"></div>

  </section>

  <!-- =========================================
       アクセス
       ========================================= -->
  <section id="access" aria-labelledby="access-h">
    <h2 id="access-h">アクセス</h2>
    <div class="card card--body">
      最寄駅から徒歩5分。駐車は近隣コインPをご利用ください。
    </div>
  </section>

  <!-- =========================================
       Q&A（アコーディオン）
       ========================================= -->
  <section id="qa" aria-labelledby="qa-h">
    <h2 id="qa-h">Q&amp;A</h2>
    <div class="accordion">
      <details open><summary>再入場は可能ですか？</summary><div>可能です。リストバンドをご提示ください。</div></details>
      <details><summary>撮影はできますか？</summary><div>被写体の許可がある場合のみ可。会場のルールに従ってください。</div></details>
      <details><summary>落とし物はどこに？</summary><div>本部までお越しください。</div></details>
    </div>
  </section>

  <!-- =========================================
       お問い合わせ（GitHub Issueフォームへ遷移想定）
       ========================================= -->
  <section id="contact" aria-labelledby="contact-h">
    <h2 id="contact-h">お問い合わせ</h2>
    <div class="card card--body">
      <p>不具合報告・改善要望は、以下から匿名で送信できます（画像のみ添付可）。</p>
      <p><a class="btn" href="https://example.com/issue-form" target="_blank" rel="noopener">Issueフォームを開く</a></p>
      <p style="font-size:.9rem;color:#64748b">※緊急時は現地スタッフへお声がけください。</p>
    </div>
  </section>

  <div class="footspace" aria-hidden="true"></div>

  <!-- ！！重要：初期化で参照するため、#toTop をスクリプトの「前」に配置！！
       これにより早期 return が発生せず、CSV 読込が確実に実行されます。 -->
  <button id="toTop" class="to-top" type="button" aria-label="先頭へ戻る">▲</button>

  <!-- =========================================
       JS：インタラクション（スクロールスパイは簡易）
       ========================================= -->
  <script>
    // --- 簡易 scrollspy（現在の見出し近辺でナビを強調）
    //     * 必須ではないため、古いブラウザでは無視されてもOK
    (function(){
      const chips = [...document.querySelectorAll('.nav .chip')];
      const ids = chips.map(a => a.getAttribute('href')).filter(Boolean).map(h=>h.replace('#',''));
      const secs = ids.map(id => document.getElementById(id)).filter(Boolean);
      const onScroll = () => {
        let activeId = null;
        const y = window.scrollY + 80;
        for(const sec of secs){
          if(sec.offsetTop <= y) activeId = sec.id;
        }
        chips.forEach(a => a.classList.toggle('is-active', a.getAttribute('href') === '#' + activeId));
      };
      window.addEventListener('scroll', onScroll, {passive:true});
      onScroll();
    })();
  </script>

  <!-- =========================================
       JS：サークル一覧 CSVロード＋検索＋50音＋企業
       ========================================= -->
  <script>
  /*
    サークル一覧：CSV → カード生成 → 検索/50音/企業 → 段階表示 + 自動読み足し + SNSリンク
    CSVヘッダ想定：
      name,pn,space,cat,thumb,kana,desc,sns
    - sns は複数URLを "空白/カンマ/|" 区切りで記述可
    - 区分(cat)はカード表示では非表示（仕様変更）
  */
  (function(){
    // ---- 要素取得 ----
    const cardsWrap = document.getElementById('circle-cards');
    const q = document.getElementById('circle-q');
    const hit = document.getElementById('hit');
    const kanaBtns = Array.from(document.querySelectorAll('.kana__btn'));
    const loadmoreBtn = document.getElementById('loadmore');
    const observerEl = document.getElementById('observer');
    const toTopBtn = document.getElementById('toTop');
    if(!cardsWrap || !q || !hit || !loadmoreBtn || !observerEl || !toTopBtn) return; // ← ここで null だと何も動かなかった

    // ---- 正規化ユーティリティ ----
    const toHira = (str) => {
      if(!str) return '';
      str = str.replace(/^\uFEFF/, '').normalize('NFKC');
      str = str.replace(/[\u30A1-\u30F6]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0x60));
      return str.replace(/\s+/g, '').toLowerCase();
    };
    const escapeHTML = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const ROW = {
      a: 'あいうえおぁぃぅぇぉ',
      k: 'かきくけこがぎぐげご',
      s: 'さしすせそざじずぜぞ',
      t: 'たちつてとだぢづでどっ',
      n: 'なにぬねの',
      h: 'はひふへほばびぶべぼぱぴぷぺぽ',
      m: 'まみむめも',
      y: 'やゆよゃゅょ',
      r: 'らりるれろ',
      w: 'わをんゎ'
    };
    const kanaRowKey = (str) => {
      const h = toHira(str).charAt(0);
      for(const key of Object.keys(ROW)){
        if(ROW[key].includes(h)) return key;
      }
      return 'other';
    };

    // ---- CSV パーサ ----
    function parseCSV(text){
      const rows = [];
      let i=0, field='', row=[], inQuote=false;
      text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      while(i<text.length){
        const c = text[i];
        if(inQuote){
          if(c === '"'){
            if(text[i+1] === '"'){ field += '"'; i+=2; continue; }
            inQuote = false; i++; continue;
          }else{ field += c; i++; continue; }
        }else{
          if(c === '"'){ inQuote = true; i++; continue; }
          if(c === ','){ row.push(field); field=''; i++; continue; }
          if(c === '\n'){ row.push(field); field=''; rows.push(row); row=[]; i++; continue; }
          field += c; i++; continue;
        }
      }
      row.push(field); rows.push(row);
      return rows;
    }
    function csvToObjects(text){
      const rows = parseCSV(text).filter(r => r.length && r.join('').trim() !== '');
      if(!rows.length) return [];
      const header = rows[0].map(h => h.trim());
      return rows.slice(1).map(cols => {
        const o = {};
        header.forEach((h, idx) => { o[h] = (cols[idx] ?? '').trim(); });
        return o;
      });
    }

    // ========================
    // SNSリンク: URL配列の正規化
    //  - スキームなしURLを https 化
    //  - 重複を排除
    // ========================
    function parseSNS(raw){
      if(!raw) return [];
      const parts = String(raw).split(/[\s,|]+/).map(s => s.trim()).filter(Boolean);

      const norm = parts.map(u => {
        // 前後の引用符や句読点を除去（CSVゆれ対策）
        u = u.replace(/^['"［「『（(]+|['"］」』）)。,、]+$/g, '').trim();
        // "//example.com" → "https://example.com"
        if (/^\/\//.test(u)) u = 'https:' + u;
        // "pixiv.net/..." → "https://pixiv.net/..."
        if (!/^https?:\/\//i.test(u) && /\./.test(u)) u = 'https://' + u;
        return u;
      });

      // URLとして解釈できるものだけ残す
      const uniq = Array.from(new Set(norm));
      return uniq.filter(u => { try{ new URL(u); return true; } catch{ return false; } });
    }

    // ========================
    // favicon取得ポリシー
    // ①（本番用 / コメントアウト）：WPにキャッシュしたPNGを配信
    //    例: /wp-content/uploads/favicons/example.com.png
    //    ※本番移行時にこの関数を有効化し、②を無効化してください。
    // ========================
    /*
    function faviconURL(host){
      // 本番：サーバー側で事前生成しておく（WP-Cronで週1更新など）
      return `/wp-content/uploads/favicons/${host}.png`;
    }
    */

    // ========================
    // ②（ドラフト用 / 有効）：CDNから取得（Google S2）
    //    相手サイトへ直接アクセスしないので負荷集中を回避
    // ========================
    function faviconURL(host, size=32){
      return `https://www.google.com/s2/favicons?domain=${encodeURIComponent(host)}&sz=${size}`;
    }

    // URL → ホスト名（失敗時はnull）
    function hostFromUrl(u){
      try { return new URL(u).hostname; } catch { return null; }
    }

    // ========================
    // SNSリンクHTML生成：favicon画像 + ラベル
    //  - faviconはCDNから取得、失敗時は非表示（ラベルのみ）
    //  - 参照元を送らないために no-referrer を付与
    // ========================
    function buildSNSHtml(urls){
      if(!urls.length) return '';
      const items = urls.map(u => {
        const host = hostFromUrl(u);
        const fav  = host ? faviconURL(host, 32) : '';
        const label= (function(){
          // 既存の snsKind/snsLabel を活用（無ければ "Web"）
          try{
            const k = snsKind(u);
            return (snsLabel && snsLabel(k)) || 'Web';
          }catch{ return 'Web'; }
        })();

        const favImg = fav
          ? `<img class="fav" src="${fav}" loading="lazy" decoding="async"
                   referrerpolicy="no-referrer" alt="" aria-hidden="true"
                   onerror="this.style.display='none'">`
          : '';

        return `<a href="${escapeHTML(u)}" target="_blank" rel="noopener" aria-label="${label}へ">
                  ${favImg}<span>${label}</span>
                </a>`;
      }).join('');

      return `<div class="sns" aria-label="SNSリンク">${items}</div>`;
    }

    function snsKind(u){
      try{
        const h = new URL(u).hostname.replace(/^www\./, '');
        if (/(x\.com|twitter\.com)$/i.test(h)) return 'x';
        if (/pixiv\.net$/i.test(h)) return 'pixiv';
        if (/booth\.pm$/i.test(h)) return 'booth';
        if (/instagram\.com$/i.test(h)) return 'ig';
        if (/bsky\.app$/i.test(h)) return 'bsky';
        if (/youtube\.com$|youtu\.be$/i.test(h)) return 'yt';
        return 'web';
      }catch{ return 'web'; }
    }
    function snsIcon(kind){
      // 小型のインラインSVG（外部依存なし）
      const map = {
        x: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 3h4.3l5 7.2L17.5 3H21l-7.4 10.6L21 21h-4.3L11 13.7 6.5 21H3l7.6-10.9L3 3z"/></svg>',
        pixiv: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="10"/></svg>',
        booth: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><rect x="3" y="6" width="18" height="12" rx="2"/></svg>',
        ig: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><rect x="4" y="4" width="16" height="16" rx="4"/><circle cx="12" cy="12" r="4"/><circle cx="17" cy="7" r="1"/></svg>',
        bsky: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 10c2-4 8-6 10 0-3 1-6 3-10 9-4-6-7-8-10-9 2-6 8-4 10 0z"/></svg>',
        yt: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><path d="M22 12c0-3-1-5-1-5s-1-2-4-2H7C4 5 3 7 3 7s-1 2-1 5 1 5 1 5 1 2 4 2h10c3 0 4-2 4-2s1-2 1-5z"/><path d="M10 9v6l5-3-5-3z" fill="#fff"/></svg>',
        web: '<svg class="i" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"/><path d="M3 12h18M12 3c3 4 3 14 0 18M7 5c2 3 2 11 0 14M17 5c-2 3-2 11 0 14"/></svg>'
      };
      return map[kind] || map.web;
    }
    function snsLabel(kind){
      return {x:'X', pixiv:'Pixiv', booth:'Booth', ig:'Instagram', bsky:'Bluesky', yt:'YouTube', web:'Web'}[kind] || 'Web';
    }
    function buildSNSHtml(urls){
      if(!urls.length) return '';
      const items = urls.map(u => {
        const k = snsKind(u);
        return `<a href="${escapeHTML(u)}" target="_blank" rel="noopener" aria-label="${snsLabel(k)}へ">
          ${snsIcon(k)}<span>${snsLabel(k)}</span>
        </a>`;
      }).join('');
      return `<div class="sns" aria-label="SNSリンク">${items}</div>`;
    }

    // ---- 状態と描画（段階表示） ----
    let allCards = [];            // 生成された <article> 要素の配列（全件）
    let filtered = [];            // フィルタ適用後の配列
    const PAGE_SIZE = 24;         // 初期/追加の表示件数
    let visibleCount = PAGE_SIZE; // 現在の表示上限
    let state = { text:'', row:'all' };

    function matchText(card, needle){
      if(!needle) return true;
      const target = [card.dataset.name, card.dataset.pn, card.dataset.space].map(toHira).join('|');
      return target.includes(toHira(needle));
    }
    function matchRow(card, row){
      if(row === 'all') return true;
      return (card.dataset.kana || 'other') === row; // 'kigyou' もここで判定
    }
    function applyFilter(){
      // フィルタを適用し、表示上限を初期化
      filtered = allCards.filter(c => matchText(c, state.text) && matchRow(c, state.row));
      visibleCount = PAGE_SIZE;
      render();
    }
    function render(){
      // 一旦すべて非表示 → 先頭 visibleCount 件だけ表示
      let count = 0;
      for(const c of allCards){ c.style.display = 'none'; }
      for(let i=0; i<filtered.length && i<visibleCount; i++){
        filtered[i].style.display = '';
        count++;
      }
      hit.textContent = String(filtered.length);
      // さらに表示ボタンの活性/非活性
      const more = filtered.length > visibleCount;
      loadmoreBtn.disabled = !more;
    }
    function showMore(){
      // 表示上限を加算して再描画
      visibleCount += PAGE_SIZE;
      render();
    }

    // ---- イベント：検索・50音・上へ戻る ----
    let timer = 0;
    q.addEventListener('input', (e) => {
      clearTimeout(timer);
      const v = e.target.value || '';
      timer = setTimeout(() => {
        state.text = v;
        updateHash();
        applyFilter();
      }, 120);
    });
    const setKanaPressed = (key) => {
      kanaBtns.forEach(btn => btn.setAttribute('aria-pressed', String(btn.dataset.kana === key)));
    };
    kanaBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        state.row = btn.dataset.kana;
        setKanaPressed(state.row);
        updateHash();
        applyFilter();
      });
    });

    // 上へ戻る
    toTopBtn.addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));
    window.addEventListener('scroll', () => {
      toTopBtn.classList.toggle('is-show', window.scrollY > 600);
    }, {passive:true});

    // ---- URLハッシュ同期（共有用） ----
    const applyHash = () => {
      const hash = new URLSearchParams(location.hash.replace(/^#/, ''));
      const qv = hash.get('q') || '';
      const rv = hash.get('row') || 'all';
      if(q.value !== qv){ q.value = qv; state.text = qv; }
      if(state.row !== rv){ state.row = rv; setKanaPressed(rv); }
      applyFilter();
    };
    const updateHash = () => {
      const params = new URLSearchParams();
      if(state.text) params.set('q', state.text);
      if(state.row && state.row !== 'all') params.set('row', state.row);
      const h = params.toString();
      if(location.hash.replace(/^#/, '') !== h){
        history.replaceState(null, '', h ? `#${h}` : '#');
      }
    };
    window.addEventListener('hashchange', applyHash);

    // ---- データロード＆カード生成 ----
    async function loadAndRender(){
      try{
        const res = await fetch(`./content/circle-list.csv?ts=${Date.now()}`);
        if(!res.ok) throw new Error('CSVの読み込みに失敗: ' + res.status);
        let text = await res.text();
        text = text.replace(/^\uFEFF/, '');
        const items = csvToObjects(text);

        cardsWrap.innerHTML = '';
        allCards.length = 0;

        for(const it of items){
          const name  = it.name || '';
          const pn    = it.pn || '';
          const space = it.space || '';
          const cat   = it.cat || '';
          const thumb = it.thumb || '';
          const desc  = it.desc || '';
          const snsRaw= it.sns || ''; // ← 複数URL対応
          const sns   = parseSNS(snsRaw);

          // kana 決定（kigyou 明示 or 自動）
          let kana = (it.kana || '').toLowerCase();
          if(!kana){
            if(space.includes('企業') || cat.includes('企業')) kana = 'kigyou';
            else kana = kanaRowKey(name || pn);
          }

          const art = document.createElement('article');
          art.className = 'card card--circle';
          art.dataset.name = name;
          art.dataset.pn = pn;
          art.dataset.space = space;
          art.dataset.kana = kana;

          // カード本体（区分は表示しない）
          const thumbHtml = thumb ? 
            `<img class="circle__thumb" src="${escapeHTML(thumb)}" alt="${escapeHTML(name)} のサムネイル" />` : '';
          const rowStart = thumb ? `<div class="circle__row">${thumbHtml}<div>` : `<div>`;
          const rowEnd   = thumb ? `</div></div>` : `</div>`;
          art.innerHTML = `
            ${rowStart}
              <div class="circle__head">
                <div class="circle__title">${escapeHTML(name)} <span class="circle__space">${escapeHTML(space)}</span></div>
                <div class="circle__meta">PN：${escapeHTML(pn)}</div>
              </div>
              <div class="circle__body">${escapeHTML(desc)}</div>
              ${buildSNSHtml(sns)}
            ${rowEnd}
          `;
          cardsWrap.appendChild(art);
          allCards.push(art);
        }

        // 初期状態
        setKanaPressed('all');
        state.text = '';
        state.row  = 'all';
        applyFilter();      // ← filtered を作って render

      }catch(err){
        console.error(err);
        cardsWrap.innerHTML = `<p class="note">サークル一覧の読み込みに失敗しました。時間をおいて再読み込みしてください。</p>`;
        hit.textContent = '0';
      }
    }

    // ---- さらに表示（手動） ----
    loadmoreBtn.addEventListener('click', showMore);

    // ---- 無限読み足し（画面下に来たら自動で showMore）----
    const io = new IntersectionObserver((entries) => {
      const ent = entries[0];
      if(ent && ent.isIntersecting){
        if(filtered.length > visibleCount){
          showMore();
        }
      }
    }, {root:null, threshold:1.0});
    io.observe(observerEl);

    // ---- 初期ロード ----
    loadAndRender().then(applyHash);
  })();
  </script>
</body>
</html>
